<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Box Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; }
        #arButton {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            z-index: 100;
        }
        #instructions {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            text-align: center;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="instructions">Point at a surface to place the box</div>
    <button id="arButton">Start AR</button>
    <script>
        class ARBoxViewer {
            constructor() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.xr.enabled = true;
                document.body.appendChild(this.renderer.domElement);

                // Get dimensions from URL
                const params = new URLSearchParams(window.location.search);
                this.dimensions = {
                    length: parseFloat(params.get('length')) || 1,
                    width: parseFloat(params.get('width')) || 1,
                    height: parseFloat(params.get('height')) || 1,
                    unit: params.get('unit') || 'm'
                };

                this.createBox();
                this.setupLights();
                this.setupAR();
            }

            createBox() {
                const scale = this.convertToMeters(this.dimensions);
                
                // Create box geometry
                const geometry = new THREE.BoxGeometry(scale.length, scale.height, scale.width);
                const material = new THREE.MeshPhongMaterial({
                    color: 0x7B89D3,
                    transparent: true,
                    opacity: 0.5,
                });
                
                this.box = new THREE.Mesh(geometry, material);
                
                // Add wireframe
                const edges = new THREE.EdgesGeometry(geometry);
                const lineMaterial = new THREE.LineBasicMaterial({ color: 0xffffff });
                const wireframe = new THREE.LineSegments(edges, lineMaterial);
                this.box.add(wireframe);
            }

            convertToMeters({ length, width, height, unit }) {
                const conversions = {
                    'm': 1,
                    'cm': 0.01,
                    'mm': 0.001,
                    'in': 0.0254,
                    'ft': 0.3048
                };
                const factor = conversions[unit] || 1;
                return {
                    length: length * factor,
                    width: width * factor,
                    height: height * factor
                };
            }

            setupLights() {
                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(1, 1, 1);
                this.scene.add(light);
                
                const ambient = new THREE.AmbientLight(0xffffff, 0.5);
                this.scene.add(ambient);
            }

            async setupAR() {
                const arButton = document.getElementById('arButton');
                
                if ('xr' in navigator) {
                    const supported = await navigator.xr.isSessionSupported('immersive-ar');
                    if (supported) {
                        arButton.addEventListener('click', () => this.startAR());
                    } else {
                        arButton.textContent = 'AR Not Supported';
                        arButton.disabled = true;
                    }
                } else {
                    arButton.textContent = 'AR Not Supported';
                    arButton.disabled = true;
                }
            }

            async startAR() {
                try {
                    const session = await navigator.xr.requestSession('immersive-ar', {
                        requiredFeatures: ['hit-test']
                    });

                    this.renderer.xr.setSession(session);
                    
                    const viewerSpace = await session.requestReferenceSpace('viewer');
                    const hitTestSource = await session.requestHitTestSource({ space: viewerSpace });

                    session.addEventListener('select', () => {
                        if (this.hitPose) {
                            this.box.position.setFromMatrixPosition(this.hitPose.transform.matrix);
                            this.scene.add(this.box);
                        }
                    });

                    this.renderer.setAnimationLoop((timestamp, frame) => {
                        if (frame) {
                            const hitTestResults = frame.getHitTestResults(hitTestSource);
                            if (hitTestResults.length > 0) {
                                this.hitPose = hitTestResults[0].getPose(viewerSpace);
                            }
                        }
                        this.renderer.render(this.scene, this.camera);
                    });

                } catch (error) {
                    console.error('Error starting AR:', error);
                    alert('Failed to start AR: ' + error.message);
                }
            }
        }

        // Start the application
        new ARBoxViewer();
    </script>
</body>
</html>
