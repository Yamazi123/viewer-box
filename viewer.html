<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Box Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; }
        #arButton {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            z-index: 100;
        }
        #instructions {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            text-align: center;
            z-index: 100;
            width: 80%;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div id="instructions">Checking AR compatibility...</div>
    <button id="arButton" style="display: none;">Start AR</button>
    <script>
        class ARBoxViewer {
            constructor() {
                this.checkDeviceCompatibility();
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.xr.enabled = true;
                document.body.appendChild(this.renderer.domElement);

                // Get dimensions from URL
                const params = new URLSearchParams(window.location.search);
                this.dimensions = {
                    length: parseFloat(params.get('length')) || 1,
                    width: parseFloat(params.get('width')) || 1,
                    height: parseFloat(params.get('height')) || 1,
                    unit: params.get('unit') || 'm'
                };

                this.createBox();
                this.setupLights();
                this.setupAR();
            }

            async checkDeviceCompatibility() {
                const instructions = document.getElementById('instructions');
                
                // Check if running on mobile
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (!isMobile) {
                    instructions.textContent = 'Please open this page on a mobile device';
                    return false;
                }

                // Check if running on HTTPS
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    instructions.textContent = 'AR requires HTTPS. Please use a secure connection.';
                    return false;
                }

                // Check WebXR support
                if (!navigator.xr) {
                    instructions.textContent = 'WebXR not available. Please use Chrome on Android or Safari on iOS 13.3+';
                    return false;
                }

                return true;
            }

            // ... rest of the methods remain the same ...

            async setupAR() {
                const arButton = document.getElementById('arButton');
                const instructions = document.getElementById('instructions');
                
                if ('xr' in navigator) {
                    try {
                        const supported = await navigator.xr.isSessionSupported('immersive-ar');
                        if (supported) {
                            instructions.textContent = 'Point at a surface to place the box';
                            arButton.style.display = 'block';
                            arButton.addEventListener('click', () => this.startAR());
                        } else {
                            instructions.textContent = 'AR not supported on this device/browser. Please use Chrome on Android or Safari on iOS 13.3+';
                            arButton.style.display = 'none';
                        }
                    } catch (error) {
                        instructions.textContent = 'Error checking AR support: ' + error.message;
                        console.error('AR support check error:', error);
                    }
                } else {
                    instructions.textContent = 'WebXR not available. Please use Chrome on Android or Safari on iOS 13.3+';
                    arButton.style.display = 'none';
                }
            }

            async startAR() {
                const instructions = document.getElementById('instructions');
                try {
                    instructions.textContent = 'Starting AR...';
                    const session = await navigator.xr.requestSession('immersive-ar', {
                        requiredFeatures: ['hit-test']
                    });

                    this.renderer.xr.setSession(session);
                    
                    const viewerSpace = await session.requestReferenceSpace('viewer');
                    const hitTestSource = await session.requestHitTestSource({ space: viewerSpace });

                    instructions.textContent = 'Tap on the surface where you want to place the box';

                    session.addEventListener('select', () => {
                        if (this.hitPose) {
                            this.box.position.setFromMatrixPosition(this.hitPose.transform.matrix);
                            this.scene.add(this.box);
                            instructions.textContent = 'Box placed! You can move around to view it';
                        }
                    });

                    this.renderer.setAnimationLoop((timestamp, frame) => {
                        if (frame) {
                            const hitTestResults = frame.getHitTestResults(hitTestSource);
                            if (hitTestResults.length > 0) {
                                this.hitPose = hitTestResults[0].getPose(viewerSpace);
                            }
                        }
                        this.renderer.render(this.scene, this.camera);
                    });

                } catch (error) {
                    console.error('Error starting AR:', error);
                    instructions.textContent = 'Failed to start AR: ' + error.message;
                }
            }
        }

        // Start the application
        new ARBoxViewer();
    </script>
</body>
</html>
